import tkinter as tk
from tkinter import filedialog
from PIL import Image, ImageTk
import importlib
import os

# DefiniÃ§Ã£o de cores
branco = "#ffffff"
azul = "#8f88ba"

# VariÃ¡veis globais
imagem_original = None
imagem_editada = None
plugins = {}


# ğŸ“‚ Abrir imagem
def abrir_imagem():
    caminho = filedialog.askopenfilename(
        filetypes=[("Imagens", "*.png;*.jpg;*.jpeg;*.bmp;*.gif")]
    )
    if caminho:
        global imagem_original, imagem_editada
        imagem_original = Image.open(caminho)
        imagem_editada = imagem_original.copy()
        exibir_imagem(imagem_editada)


# ğŸ–¼ï¸ Exibir imagem no canvas
def exibir_imagem(img):
    img.thumbnail((800, 800))  # Redimensiona para caber na tela
    img_tk = ImageTk.PhotoImage(img)
    canvas.img_tk = img_tk
    canvas.create_image(200, 200, anchor=tk.CENTER, image=img_tk)


# ğŸ”„ Restaurar imagem original
def restaurar_original():
    global imagem_editada
    if imagem_original:
        imagem_editada = imagem_original.copy()
        exibir_imagem(imagem_editada)


# ğŸ’¾ Salvar imagem editada
def salvar_imagem():
    if imagem_editada:
        caminho = filedialog.asksaveasfilename(
            defaultextension=".png",
            filetypes=[("PNG", "*.png"), ("JPEG", "*.jpg"), ("BMP", "*.bmp")],
        )
        if caminho:
            imagem_editada.save(caminho)


# ğŸ§© Carregar plugins automaticamente
def carregar_plugins():
    global plugins
    plugins.clear()
    pasta_plugins = "plugins"

    # Criar a pasta de plugins se nÃ£o existir
    os.makedirs(pasta_plugins, exist_ok=True)

    # Criar __init__.py para tornar a pasta um pacote Python
    with open(os.path.join(pasta_plugins, "__init__.py"), "w") as f:
        pass

    # Buscar arquivos de plugins
    for arquivo in os.listdir(pasta_plugins):
        if arquivo.endswith(".py") and not arquivo.startswith("__"):
            nome_modulo = f"plugins.{arquivo[:-3]}"
            try:
                modulo = importlib.import_module(nome_modulo)
                importlib.reload(
                    modulo
                )  # Recarregar mÃ³dulo caso jÃ¡ tenha sido carregado
                if hasattr(modulo, "aplicar"):
                    nome_plugin = getattr(
                        modulo, "PLUGIN_NOME", arquivo[:-3].capitalize()
                    )
                    icone_plugin = getattr(modulo, "PLUGIN_ICONE", "ğŸ¨")
                    plugins[nome_plugin] = (modulo, icone_plugin)
            except Exception as e:
                print(f"Erro ao carregar plugin {arquivo}: {e}")


# ğŸ¨ Criar botÃµes dos plugins
def atualizar_lista_plugins():
    for widget in frame_plugins.winfo_children():
        widget.destroy()

    # Criar separador
    separador = tk.Label(
        frame_plugins,
        text=" Plugins ",
        bg="lightgray",
        width=18,
        font=("Arial", 10, "bold"),
    )
    separador.pack(pady=5)

    # Criar botÃµes para cada plugin
    for nome_plugin, (modulo, icone) in plugins.items():
        btn_efeito = tk.Button(
            frame_plugins,
            text=f"{icone} {nome_plugin}",
            command=lambda m=modulo: aplicar_efeito(m),
            width=18,
        )
        btn_efeito.pack(pady=2)

    # Adicionar botÃ£o "Refresh Plugins" no final
    btn_refresh = tk.Button(
        frame_plugins, text="ğŸ”„ Refresh Plugins", command=atualizar_plugins, width=18
    )
    btn_refresh.pack(pady=5)


# ğŸ”„ Aplicar efeito de um plugin
def aplicar_efeito(modulo):
    global imagem_editada
    if imagem_original:
        imagem_editada = modulo.aplicar(imagem_original.copy())
        exibir_imagem(imagem_editada)


# ğŸ”„ Recarregar plugins e atualizar interface
def atualizar_plugins():
    carregar_plugins()
    atualizar_lista_plugins()


# ğŸ¨ Criar interface grÃ¡fica
root = tk.Tk()
root.title("Pythonshop")
root.geometry("1024x800")

# ğŸ“Œ Criar frame para botÃµes principais
frame_botoes = tk.Frame(root, padx=10, pady=10, bg="lightgray")
frame_botoes.pack(side=tk.LEFT, fill=tk.Y)

# ğŸ–¼ï¸ Criar canvas para exibir imagem
canvas = tk.Canvas(root, width=800, height=800, bg="gray")
canvas.pack(side=tk.RIGHT, expand=True)

# ğŸ”˜ Criar botÃµes principais (topo)
btn_abrir = tk.Button(
    frame_botoes, text="ğŸ“‚ Abrir Imagem", command=abrir_imagem, width=18
)
btn_abrir.pack(pady=5)

btn_restaurar = tk.Button(
    frame_botoes, text="ğŸ”„ Restaurar", command=restaurar_original, width=18
)
btn_restaurar.pack(pady=5)

btn_salvar = tk.Button(frame_botoes, text="ğŸ’¾ Salvar", command=salvar_imagem, width=18)
btn_salvar.pack(pady=5)

# ğŸ“Œ Criar frame para plugins (fica abaixo dos botÃµes principais)
frame_plugins = tk.Frame(frame_botoes, padx=5, pady=5, bg=azul)
frame_plugins.pack(fill=tk.BOTH, expand=True)

# ğŸš€ Carregar plugins ao iniciar o programa
atualizar_plugins()

# ğŸ Executar a interface grÃ¡fica
root.mainloop()
